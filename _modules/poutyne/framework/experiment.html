

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>poutyne.framework.experiment &mdash; Poutyne 0.8.2 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/poutyne-light.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.8.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiment.html">Experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../callbacks.html">Callbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../layers.html">Layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">Utils</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Poutyne</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>poutyne.framework.experiment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for poutyne.framework.experiment</h1><div class="highlight"><pre>
<span></span><span class="c1"># pylint: disable=redefined-builtin</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="kc">None</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">torch.utils.tensorboard</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SummaryWriter</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">poutyne.framework</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">poutyne.utils</span> <span class="kn">import</span> <span class="n">set_seeds</span>
<span class="kn">from</span> <span class="nn">poutyne.framework.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> \
    <span class="n">OptimizerCheckpoint</span><span class="p">,</span> \
    <span class="n">LRSchedulerCheckpoint</span><span class="p">,</span> \
    <span class="n">PeriodicSaveLambda</span><span class="p">,</span> \
    <span class="n">AtomicCSVLogger</span><span class="p">,</span> \
    <span class="n">TensorBoardLogger</span><span class="p">,</span> \
    <span class="n">BestModelRestore</span>


<div class="viewcode-block" id="Experiment"><a class="viewcode-back" href="../../../experiment.html#poutyne.framework.Experiment">[docs]</a><span class="k">class</span> <span class="nc">Experiment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Experiment class provides a straightforward experimentation tool for efficient and entirely</span>
<span class="sd">    customizable finetuning of the whole neural network training procedure with PyTorch. The</span>
<span class="sd">    ``Experiment`` object takes care of the training and testing processes while also managing to</span>
<span class="sd">    keep traces of all pertinent information via the automatic logging option.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (str): Path to the experiment&#39;s working directory. Will be used for the automatic logging.</span>
<span class="sd">        network (torch.nn.Module): A PyTorch network.</span>
<span class="sd">        device (torch.torch.device): The device to which the model is sent. If None, the model will be</span>
<span class="sd">            kept on its current device.</span>
<span class="sd">            (Default value = None)</span>
<span class="sd">        logging (bool): Whether or not to log the experiment&#39;s progress. If true, various logging</span>
<span class="sd">            callbacks will be inserted to output training and testing stats as well as to automatically</span>
<span class="sd">            save model checkpoints, for example. See :func:`~Experiment.train()` and :func:`~Experiment.test()`</span>
<span class="sd">            for more details.</span>
<span class="sd">            (Default value = True)</span>
<span class="sd">        optimizer (Union[torch.optim.Optimizer, str]): If Pytorch Optimizer, must already be initialized.</span>
<span class="sd">            If str, should be the optimizer&#39;s name in Pytorch (i.e. &#39;Adam&#39; for torch.optim.Adam).</span>
<span class="sd">            (Default value = &#39;sgd&#39;)</span>
<span class="sd">        loss_function(Union[Callable, str]) It can be any PyTorch</span>
<span class="sd">            loss layer or custom loss function. It can also be a string with the same name as a PyTorch</span>
<span class="sd">            loss function (either the functional or object name). The loss function must have the signature</span>
<span class="sd">            ``loss_function(input, target)`` where ``input`` is the prediction of the network and ``target``</span>
<span class="sd">            is the ground truth. If ``None``, will default to, in priority order, either the model&#39;s own</span>
<span class="sd">            loss function or the default loss function associated with the ``task``.</span>
<span class="sd">            (Default value = None)</span>
<span class="sd">        batch_metrics (list): List of functions with the same signature as the loss function. Each metric</span>
<span class="sd">            can be any PyTorch loss function. It can also be a string with the same name as a PyTorch</span>
<span class="sd">            loss function (either the functional or object name). &#39;accuracy&#39; (or just &#39;acc&#39;) is also a</span>
<span class="sd">            valid metric. Each metric function is called on each batch of the optimization and on the</span>
<span class="sd">            validation batches at the end of the epoch.</span>
<span class="sd">            (Default value = None)</span>
<span class="sd">        epoch_metrics (list): List of functions with the same signature as</span>
<span class="sd">            :class:`~poutyne.framework.metrics.epoch_metrics.EpochMetric`</span>
<span class="sd">            (Default value = None)</span>
<span class="sd">        monitor_metric (str): Which metric to consider for best model performance calculation. Should be in</span>
<span class="sd">            the format &#39;{metric_name}&#39; or &#39;val_{metric_name}&#39; (i.e. &#39;val_loss&#39;). If None, will follow the value</span>
<span class="sd">            suggested by ``task`` or default to &#39;val_loss&#39;.</span>

<span class="sd">            .. warning:: If you do not plan on using a validation set, you must set the monitor metric to another</span>
<span class="sd">                value.</span>
<span class="sd">        monitor_mode (str): Which mode, either &#39;min&#39; or &#39;max&#39;, should be used when considering the ``monitor_metric``</span>
<span class="sd">            value. If None, will follow the value suggested by ``task`` or default to &#39;min&#39;.</span>
<span class="sd">        task (str): Any str beginning with either &#39;classif&#39; or &#39;reg&#39;. Specifying a ``task`` can assign default</span>
<span class="sd">            values to the ``loss_function``, ``batch_metrics``, ``monitor_mode`` and ``monitor_mode``. For ``task``</span>
<span class="sd">            that begins with &#39;reg&#39;, the only default value is the loss function that is the mean squared error. When</span>
<span class="sd">            beginning with &#39;classif&#39;, the default loss function is the cross-entropy loss, the default batch metrics</span>
<span class="sd">            will be the accuracy, the default epoch metrics will be the F1 score and the default monitoring will be</span>
<span class="sd">            set on &#39;val_acc&#39; with a &#39;max&#39; mode.</span>
<span class="sd">            (Default value = None)</span>

<span class="sd">    Example:</span>
<span class="sd">        Using a PyTorch DataLoader, on classification task with SGD optimizer::</span>

<span class="sd">            import torch</span>
<span class="sd">            from torch.utils.data import DataLoader, TensorDataset</span>
<span class="sd">            from poutyne.framework import Experiment</span>

<span class="sd">            num_features = 20</span>
<span class="sd">            num_classes = 5</span>

<span class="sd">            # Our training dataset with 800 samples.</span>
<span class="sd">            num_train_samples = 800</span>
<span class="sd">            train_x = torch.rand(num_train_samples, num_features)</span>
<span class="sd">            train_y = torch.randint(num_classes, (num_train_samples, ), dtype=torch.long)</span>
<span class="sd">            train_dataset = TensorDataset(train_x, train_y)</span>
<span class="sd">            train_generator = DataLoader(train_dataset, batch_size=32)</span>

<span class="sd">            # Our validation dataset with 200 samples.</span>
<span class="sd">            num_valid_samples = 200</span>
<span class="sd">            valid_x = torch.rand(num_valid_samples, num_features)</span>
<span class="sd">            valid_y = torch.randint(num_classes, (num_valid_samples, ), dtype=torch.long)</span>
<span class="sd">            valid_dataset = TensorDataset(valid_x, valid_y)</span>
<span class="sd">            valid_generator = DataLoader(valid_dataset, batch_size=32)</span>

<span class="sd">            # Our network</span>
<span class="sd">            pytorch_network = torch.nn.Linear(num_features, num_train_samples)</span>

<span class="sd">            # Intialization of our experimentation and network training</span>
<span class="sd">            exp = Experiment(&#39;./simple_example&#39;,</span>
<span class="sd">                             pytorch_network,</span>
<span class="sd">                             optimizer=&#39;sgd&#39;,</span>
<span class="sd">                             task=&#39;classif&#39;)</span>
<span class="sd">            exp.train(train_generator, valid_generator, epochs=5)</span>

<span class="sd">    The above code will yield an output similar to the below lines. Note the automatic checkpoint saving</span>
<span class="sd">    in the experiment directory when the monitored metric improved.</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">            Epoch 1/5 0.09s Step 25/25: loss: 6.351375, acc: 1.375000, val_loss: 6.236106, val_acc: 5.000000</span>
<span class="sd">            Epoch 1: val_acc improved from -inf to 5.00000, saving file to ./simple_example/checkpoint_epoch_1.ckpt</span>
<span class="sd">            Epoch 2/5 0.10s Step 25/25: loss: 6.054254, acc: 14.000000, val_loss: 5.944495, val_acc: 19.500000</span>
<span class="sd">            Epoch 2: val_acc improved from 5.00000 to 19.50000, saving file to ./simple_example/checkpoint_epoch_2.ckpt</span>
<span class="sd">            Epoch 3/5 0.09s Step 25/25: loss: 5.759377, acc: 22.875000, val_loss: 5.655412, val_acc: 21.000000</span>
<span class="sd">            Epoch 3: val_acc improved from 19.50000 to 21.00000, saving file to ./simple_example/checkpoint_epoch_3.ckpt</span>
<span class="sd">            ...</span>

<span class="sd">    Training can now easily be resumed from the best checkpoint::</span>

<span class="sd">            exp.train(train_generator, valid_generator, epochs=10)</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">            Restoring model from ./simple_example/checkpoint_epoch_3.ckpt</span>
<span class="sd">            Loading weights from ./simple_example/checkpoint.ckpt and starting at epoch 6.</span>
<span class="sd">            Loading optimizer state from ./simple_example/checkpoint.optim and starting at epoch 6.</span>
<span class="sd">            Epoch 6/10 0.16s Step 25/25: loss: 4.897135, acc: 22.875000, val_loss: 4.813141, val_acc: 20.500000</span>
<span class="sd">            Epoch 7/10 0.10s Step 25/25: loss: 4.621514, acc: 22.625000, val_loss: 4.545359, val_acc: 20.500000</span>
<span class="sd">            Epoch 8/10 0.24s Step 25/25: loss: 4.354721, acc: 23.625000, val_loss: 4.287117, val_acc: 20.500000</span>
<span class="sd">            ...</span>

<span class="sd">    Testing is also very intuitive::</span>

<span class="sd">            exp.test(test_generator)</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">            Restoring model from ./simple_example/checkpoint_epoch_9.ckpt</span>
<span class="sd">            Found best checkpoint at epoch: 9</span>
<span class="sd">            lr: 0.01, loss: 4.09892, acc: 23.625, val_loss: 4.04057, val_acc: 21.5</span>
<span class="sd">            On best model: test_loss: 4.06664, test_acc: 17.5</span>


<span class="sd">    Finally, all the pertinent metrics specified to the Experiment at each epoch are stored in a specific logging</span>
<span class="sd">    file, found here at &#39;./simple_example/log.tsv&#39;.</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">            epoch	time	            lr	    loss	            acc	    val_loss	        val_acc</span>
<span class="sd">            1	    0.0721172170015052	0.01	6.351375141143799	1.375	6.23610631942749	5.0</span>
<span class="sd">            2	    0.0298177790245972	0.01	6.054253826141357	14.000	5.94449516296386	19.5</span>
<span class="sd">            3	    0.0637106419890187	0.01	5.759376544952392	22.875	5.65541223526001	21.0</span>
<span class="sd">            ...</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">BEST_CHECKPOINT_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;checkpoint_epoch_</span><span class="si">{epoch}</span><span class="s1">.ckpt&#39;</span>
    <span class="n">BEST_CHECKPOINT_TMP_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;checkpoint_epoch.tmp.ckpt&#39;</span>
    <span class="n">MODEL_CHECKPOINT_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;checkpoint.ckpt&#39;</span>
    <span class="n">MODEL_CHECKPOINT_TMP_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;checkpoint.tmp.ckpt&#39;</span>
    <span class="n">OPTIMIZER_CHECKPOINT_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;checkpoint.optim&#39;</span>
    <span class="n">OPTIMIZER_CHECKPOINT_TMP_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;checkpoint.tmp.optim&#39;</span>
    <span class="n">LOG_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;log.tsv&#39;</span>
    <span class="n">LOG_TMP_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;log.tmp.tsv&#39;</span>
    <span class="n">TENSORBOARD_DIRECTORY</span> <span class="o">=</span> <span class="s1">&#39;tensorboard&#39;</span>
    <span class="n">EPOCH_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;last.epoch&#39;</span>
    <span class="n">EPOCH_TMP_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;last.tmp.epoch&#39;</span>
    <span class="n">LR_SCHEDULER_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;lr_sched_</span><span class="si">%d</span><span class="s1">.lrsched&#39;</span>
    <span class="n">LR_SCHEDULER_TMP_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;lr_sched_</span><span class="si">%d</span><span class="s1">.tmp.lrsched&#39;</span>
    <span class="n">TEST_LOG_FILENAME</span> <span class="o">=</span> <span class="s1">&#39;test_log.tsv&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">directory</span><span class="p">,</span>
                 <span class="n">network</span><span class="p">,</span>
                 <span class="o">*</span><span class="p">,</span>
                 <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">logging</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;sgd&#39;</span><span class="p">,</span>
                 <span class="n">loss_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">batch_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">epoch_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">monitor_metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">monitor_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">task</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging</span> <span class="o">=</span> <span class="n">logging</span>

        <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;classif&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;reg&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid task &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="p">)</span>

        <span class="n">batch_metrics</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">batch_metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">batch_metrics</span>
        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">epoch_metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">epoch_metrics</span>

        <span class="n">loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_loss_function</span><span class="p">(</span><span class="n">loss_function</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="n">batch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_batch_metrics</span><span class="p">(</span><span class="n">batch_metrics</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_epoch_metrics</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_monitor</span><span class="p">(</span><span class="n">monitor_metric</span><span class="p">,</span> <span class="n">monitor_mode</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loss_function</span><span class="p">,</span> <span class="n">batch_metrics</span><span class="o">=</span><span class="n">batch_metrics</span><span class="p">,</span> <span class="n">epoch_metrics</span><span class="o">=</span><span class="n">epoch_metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">BEST_CHECKPOINT_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint_tmp_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">BEST_CHECKPOINT_TMP_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">MODEL_CHECKPOINT_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_tmp_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">MODEL_CHECKPOINT_TMP_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_checkpoint_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">OPTIMIZER_CHECKPOINT_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_checkpoint_tmp_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">OPTIMIZER_CHECKPOINT_TMP_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">LOG_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_tmp_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">LOG_TMP_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">TENSORBOARD_DIRECTORY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">EPOCH_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_tmp_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">EPOCH_TMP_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">LR_SCHEDULER_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler_tmp_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">LR_SCHEDULER_TMP_FILENAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_log_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">Experiment</span><span class="o">.</span><span class="n">TEST_LOG_FILENAME</span><span class="p">)</span>

<div class="viewcode-block" id="Experiment.get_path"><a class="viewcode-back" href="../../../experiment.html#poutyne.framework.Experiment.get_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path inside the experiment directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_loss_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_function</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">loss_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="s1">&#39;loss_function&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">network</span><span class="o">.</span><span class="n">loss_function</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;classif&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s1">&#39;cross_entropy&#39;</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;reg&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s1">&#39;mse&#39;</span>
        <span class="k">return</span> <span class="n">loss_function</span>

    <span class="k">def</span> <span class="nf">_get_batch_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_metrics</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">batch_metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="s1">&#39;batch_metrics&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">network</span><span class="o">.</span><span class="n">batch_metrics</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;classif&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">batch_metrics</span>

    <span class="k">def</span> <span class="nf">_get_epoch_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_metrics</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch_metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="s1">&#39;epoch_metrics&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">network</span><span class="o">.</span><span class="n">epoch_metrics</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;classif&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">epoch_metrics</span>

    <span class="k">def</span> <span class="nf">_set_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor_metric</span><span class="p">,</span> <span class="n">monitor_mode</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">monitor_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">monitor_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid mode &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">monitor_mode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span> <span class="o">=</span> <span class="s1">&#39;val_loss&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
        <span class="k">if</span> <span class="n">monitor_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span> <span class="o">=</span> <span class="n">monitor_metric</span>
            <span class="k">if</span> <span class="n">monitor_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span> <span class="o">=</span> <span class="n">monitor_mode</span>
        <span class="k">elif</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;classif&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span> <span class="o">=</span> <span class="s1">&#39;val_acc&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>

<div class="viewcode-block" id="Experiment.get_best_epoch_stats"><a class="viewcode-back" href="../../../experiment.html#poutyne.framework.Experiment.get_best_epoch_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_best_epoch_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all computed statistics corresponding to the best epoch according to the</span>
<span class="sd">        ``monitor_metric`` and ``monitor_mode`` attributes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict where each key is a column name in the logging output file</span>
<span class="sd">            and values are the ones found at the best epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;pandas needs to be installed to use this function.&quot;</span><span class="p">)</span>

        <span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">best_epoch_index</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_epoch_index</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">history</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">best_epoch_index</span><span class="p">:</span><span class="n">best_epoch_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Experiment.get_saved_epochs"><a class="viewcode-back" href="../../../experiment.html#poutyne.framework.Experiment.get_saved_epochs">[docs]</a>    <span class="k">def</span> <span class="nf">get_saved_epochs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a pandas DataFrame which each row corresponds to an epoch having</span>
<span class="sd">        a saved checkpoint.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas DataFrame which each row corresponds to an epoch having a saved</span>
<span class="sd">            checkpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;pandas needs to be installed to use this function.&quot;</span><span class="p">)</span>

        <span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">monitor_op</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span>
            <span class="n">current_best</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">monitor_op</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span>
            <span class="n">current_best</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;Inf&#39;</span><span class="p">)</span>
        <span class="n">saved_epoch_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">monitor_op</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">current_best</span><span class="p">):</span>
                <span class="n">current_best</span> <span class="o">=</span> <span class="n">metric</span>
                <span class="n">saved_epoch_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">history</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">saved_epoch_indices</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_warn_missing_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Missing checkpoint: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_epoch_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr_schedulers</span><span class="p">):</span>
        <span class="c1"># pylint: disable=broad-except</span>
        <span class="n">initial_epoch</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">initial_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_filename</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading weights from </span><span class="si">%s</span><span class="s2"> and starting at epoch </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_filename</span><span class="p">,</span> <span class="n">initial_epoch</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_filename</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_missing_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_checkpoint_filename</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading optimizer state from </span><span class="si">%s</span><span class="s2"> and starting at epoch </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_checkpoint_filename</span><span class="p">,</span> <span class="n">initial_epoch</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_optimizer_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_checkpoint_filename</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_missing_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_checkpoint_filename</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lr_scheduler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lr_schedulers</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler_filename</span> <span class="o">%</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading LR scheduler state from </span><span class="si">%s</span><span class="s2"> and starting at epoch </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">initial_epoch</span><span class="p">))</span>
                        <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">load_state</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_warn_missing_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">initial_epoch</span>

    <span class="k">def</span> <span class="nf">_init_model_restoring_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_epoch</span><span class="p">,</span> <span class="n">save_every_epoch</span><span class="p">):</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">best_checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint_filename</span><span class="p">,</span>
                                          <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span><span class="p">,</span>
                                          <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span><span class="p">,</span>
                                          <span class="n">save_best_only</span><span class="o">=</span><span class="ow">not</span> <span class="n">save_every_epoch</span><span class="p">,</span>
                                          <span class="n">restore_best</span><span class="o">=</span><span class="ow">not</span> <span class="n">save_every_epoch</span><span class="p">,</span>
                                          <span class="n">verbose</span><span class="o">=</span><span class="ow">not</span> <span class="n">save_every_epoch</span><span class="p">,</span>
                                          <span class="n">temporary_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint_tmp_filename</span><span class="p">)</span>
        <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_checkpoint</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_every_epoch</span><span class="p">:</span>
            <span class="n">best_restore</span> <span class="o">=</span> <span class="n">BestModelRestore</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_restore</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">initial_epoch</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># We set the current best metric score in the ModelCheckpoint so that</span>
            <span class="c1"># it does not save checkpoint it would not have saved if the</span>
            <span class="c1"># optimization was not stopped.</span>
            <span class="n">best_epoch_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_epoch_stats</span><span class="p">()</span>
            <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">best_epoch_stats</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">best_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint_filename</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">best_epoch</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">save_every_epoch</span><span class="p">:</span>
                <span class="n">best_checkpoint</span><span class="o">.</span><span class="n">best_filename</span> <span class="o">=</span> <span class="n">best_filename</span>
                <span class="n">best_checkpoint</span><span class="o">.</span><span class="n">current_best</span> <span class="o">=</span> <span class="n">best_epoch_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_restore</span><span class="o">.</span><span class="n">best_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">best_filename</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
                <span class="n">best_restore</span><span class="o">.</span><span class="n">current_best</span> <span class="o">=</span> <span class="n">best_epoch_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">callbacks</span>

    <span class="k">def</span> <span class="nf">_init_tensorboard_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disable_tensorboard</span><span class="p">):</span>
        <span class="n">tensorboard_writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_tensorboard</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">SummaryWriter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;tensorboard does not seem to be installed. &quot;</span>
                    <span class="s2">&quot;To remove this warning, set the &#39;disable_tensorboard&#39; &quot;</span>
                    <span class="s2">&quot;flag to True or install tensorboard.&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tensorboard_writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorboard_directory</span><span class="p">)</span>
                <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">TensorBoardLogger</span><span class="p">(</span><span class="n">tensorboard_writer</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">tensorboard_writer</span><span class="p">,</span> <span class="n">callbacks</span>

    <span class="k">def</span> <span class="nf">_init_lr_scheduler_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lr_schedulers</span><span class="p">):</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lr_scheduler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lr_schedulers</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler_filename</span> <span class="o">%</span> <span class="n">i</span>
                <span class="n">tmp_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler_tmp_filename</span> <span class="o">%</span> <span class="n">i</span>
                <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">LRSchedulerCheckpoint</span><span class="p">(</span><span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">temporary_filename</span><span class="o">=</span><span class="n">tmp_filename</span><span class="p">)</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">callbacks</span> <span class="o">+=</span> <span class="n">lr_schedulers</span>
            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">BestModelRestore</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_metric</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_mode</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">callbacks</span>

<div class="viewcode-block" id="Experiment.train"><a class="viewcode-back" href="../../../experiment.html#poutyne.framework.Experiment.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">train_generator</span><span class="p">,</span>
              <span class="n">valid_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="o">*</span><span class="p">,</span>
              <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">lr_schedulers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">save_every_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">disable_tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
              <span class="n">steps_per_epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">validation_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">batches_per_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
        <span class="c1"># pylint: disable=too-many-locals</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trains or finetunes the attribute model on a dataset using a generator. If a previous training already occured</span>
<span class="sd">        and lasted a total of `n_previous` epochs, then the model&#39;s weights will be set to the last checkpoint and the</span>
<span class="sd">        training will be resumed for epochs range (`n_previous`, `epochs`].</span>

<span class="sd">        If the Experiment has logging enabled (i.e. self.logging is True), numerous callbacks will be automatically</span>
<span class="sd">        included. Notably, two :class:`~callbacks.ModelCheckpoint` objects will take care of saving the last and every</span>
<span class="sd">        new best (according to monitor mode) model weights in appropriate checkpoint files.</span>
<span class="sd">        :class:`~callbacks.OptimizerCheckpoint` and :class:`~callbacks.LRSchedulerCheckpoint` will also respectively</span>
<span class="sd">        handle the saving of the optimizer and LR scheduler&#39;s respective states for future retrieval. Moreover, a</span>
<span class="sd">        :class:`~callbacks.AtomicCSVLogger` will save all available epoch statistics in an output .tsv file. Lastly, a</span>
<span class="sd">        :class:`~callbacks.TensorBoardLogger` handles automatic TensorBoard logging of various neural network</span>
<span class="sd">        statistics.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_generator: Generator-like object for the training set. See :func:`~Model.fit_generator()`</span>
<span class="sd">                for details on the types of generators supported.</span>
<span class="sd">            valid_generator (optional): Generator-like object for the validation set. See</span>
<span class="sd">                :func:`~Model.fit_generator()` for details on the types of generators supported.</span>
<span class="sd">                (Default value = None)</span>
<span class="sd">            callbacks (List[~poutyne.framework.callbacks.Callback]): List of callbacks that will be called during</span>
<span class="sd">                training.</span>
<span class="sd">                (Default value = None)</span>
<span class="sd">            lr_schedulers (List[~poutyne.framework.callbacks.lr_scheduler._PyTorchLRSchedulerWrapper]): List of</span>
<span class="sd">                learning rate schedulers.</span>
<span class="sd">                (Default value = None)</span>
<span class="sd">            save_every_epoch (bool, optional): Whether or not to save the experiment model&#39;s weights after</span>
<span class="sd">                every epoch.</span>
<span class="sd">                (Default value = False)</span>
<span class="sd">            disable_tensorboard (bool, optional): Whether or not to disable the automatic tensorboard logging</span>
<span class="sd">                callbacks.</span>
<span class="sd">                (Default value = False)</span>
<span class="sd">            epochs (int): Number of times the entire training dataset is seen.</span>
<span class="sd">                (Default value = 1000)</span>
<span class="sd">            steps_per_epoch (int, optional): Number of batch used during one epoch. Obviously, using this</span>
<span class="sd">                argument may cause one epoch not to see the entire training dataset or see it multiple times.</span>
<span class="sd">                (Defaults the number of steps needed to see the entire</span>
<span class="sd">                training dataset)</span>
<span class="sd">            validation_steps (int, optional): Same as for ``steps_per_epoch`` but for the validation dataset.</span>
<span class="sd">                (Defaults to ``steps_per_epoch`` if provided or the number of steps needed to see the entire</span>
<span class="sd">                validation dataset)</span>
<span class="sd">            batches_per_step (int): Number of batches on which to compute the running loss before</span>
<span class="sd">                backpropagating it through the network. Note that the total loss used for backpropagation is</span>
<span class="sd">                the mean of the `batches_per_step` batch losses.</span>
<span class="sd">                (Default value = 1)</span>
<span class="sd">            seed (int, optional): Seed used to make the sampling deterministic.</span>
<span class="sd">                (Default value = 42)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dict containing the history of each epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_seeds</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">callbacks</span>
        <span class="n">lr_schedulers</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">lr_schedulers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lr_schedulers</span>

        <span class="c1"># Copy callback list.</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="n">tensorboard_writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">initial_epoch</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>

            <span class="c1"># Restarting optimization if needed.</span>
            <span class="n">initial_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_epoch_state</span><span class="p">(</span><span class="n">lr_schedulers</span><span class="p">)</span>

            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">AtomicCSVLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_filename</span><span class="p">,</span>
                                <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">append</span><span class="o">=</span><span class="n">initial_epoch</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">temporary_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_tmp_filename</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">callbacks</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_model_restoring_callbacks</span><span class="p">(</span><span class="n">initial_epoch</span><span class="p">,</span> <span class="n">save_every_epoch</span><span class="p">)</span>
            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_filename</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">temporary_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_tmp_filename</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">OptimizerCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_checkpoint_filename</span><span class="p">,</span>
                                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">temporary_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_checkpoint_tmp_filename</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># We save the last epoch number after the end of the epoch so that the</span>
            <span class="c1"># _load_epoch_state() knows which epoch to restart the optimization.</span>
            <span class="n">callbacks</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">PeriodicSaveLambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fd</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">fd</span><span class="p">),</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">epoch_filename</span><span class="p">,</span>
                                   <span class="n">temporary_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_tmp_filename</span><span class="p">,</span>
                                   <span class="n">open_mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">tensorboard_writer</span><span class="p">,</span> <span class="n">cb_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_tensorboard_callbacks</span><span class="p">(</span><span class="n">disable_tensorboard</span><span class="p">)</span>
            <span class="n">callbacks</span> <span class="o">+=</span> <span class="n">cb_list</span>

        <span class="c1"># This method returns callbacks that checkpoints the LR scheduler if logging is enabled.</span>
        <span class="c1"># Otherwise, it just returns the list of LR schedulers with a BestModelRestore callback.</span>
        <span class="n">callbacks</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_lr_scheduler_callbacks</span><span class="p">(</span><span class="n">lr_schedulers</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">train_generator</span><span class="p">,</span>
                                            <span class="n">valid_generator</span><span class="p">,</span>
                                            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                                            <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                                            <span class="n">validation_steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">,</span>
                                            <span class="n">batches_per_step</span><span class="o">=</span><span class="n">batches_per_step</span><span class="p">,</span>
                                            <span class="n">initial_epoch</span><span class="o">=</span><span class="n">initial_epoch</span><span class="p">,</span>
                                            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tensorboard_writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tensorboard_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Experiment.load_checkpoint"><a class="viewcode-back" href="../../../experiment.html#poutyne.framework.Experiment.load_checkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">load_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the attribute model&#39;s weights with the weights at a given checkpoint epoch.</span>

<span class="sd">        Args:</span>
<span class="sd">            checkpoint (Union[int, str]): Which checkpoint to load the model&#39;s weights form.</span>
<span class="sd">                If &#39;best&#39;, will load the best weights according to ``monitor_metric`` and ``monitor_mode``.</span>
<span class="sd">                If &#39;last&#39;, will load the last model checkpoint. If int, will load the checkpoint of the</span>
<span class="sd">                specified epoch.</span>
<span class="sd">            verbose (bool, optional): Whether or not to print the best epoch number and stats when</span>
<span class="sd">                checkpoint is &#39;best&#39;.</span>
<span class="sd">                (Default value = False)</span>

<span class="sd">        Returns:</span>
<span class="sd">            If checkpoint is &#39;best&#39;, will return the best epoch stats, as per :func:`~get_best_epoch_stats()`,</span>
<span class="sd">            else None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">best_epoch_stats</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_epoch_checkpoint</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">checkpoint</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
            <span class="n">best_epoch_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_best_checkpoint</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">checkpoint</span> <span class="o">==</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_last_checkpoint</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;checkpoint argument must be either &#39;best&#39;, &#39;last&#39; or int. Found : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">best_epoch_stats</span></div>

    <span class="k">def</span> <span class="nf">_load_epoch_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="n">ckpt_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_checkpoint_filename</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ckpt_filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No checkpoint found for epoch </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">ckpt_filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_best_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">best_epoch_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_best_epoch_stats</span><span class="p">()</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">best_epoch_stats</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">metrics_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">best_epoch_stats</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                                    <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">best_epoch_stats</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found best checkpoint at epoch: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_epoch</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">metrics_str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_epoch_checkpoint</span><span class="p">(</span><span class="n">best_epoch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_epoch_stats</span>

    <span class="k">def</span> <span class="nf">_load_last_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_checkpoint_filename</span><span class="p">)</span>

<div class="viewcode-block" id="Experiment.test"><a class="viewcode-back" href="../../../experiment.html#poutyne.framework.Experiment.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_generator</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes and returns the loss and the metrics of the attribute model on a given test examples</span>
<span class="sd">        generator.</span>

<span class="sd">        If the Experiment has logging enabled (i.e. self.logging is True), test and validation statistics</span>
<span class="sd">        are saved in a specific test output .tsv file.</span>

<span class="sd">        Args:</span>
<span class="sd">            test_generator: Generator-like object for the test set. See :func:`~Model.fit_generator()` for</span>
<span class="sd">                details on the types of generators supported.</span>
<span class="sd">            callbacks (List[~poutyne.framework.callbacks.Callback]): List of callbacks that will be called during</span>
<span class="sd">                the testing.</span>
<span class="sd">                (Default value = None)</span>
<span class="sd">            steps (int, optional): Number of iterations done on ``generator``.</span>
<span class="sd">                (Defaults the number of steps needed to see the entire dataset)</span>
<span class="sd">            checkpoint (Union[str, int]): Which model checkpoint weights to load for the test evaluation.</span>
<span class="sd">                If &#39;best&#39;, will load the best weights according to ``monitor_metric`` and ``monitor_mode``.</span>
<span class="sd">                If &#39;last&#39;, will load the last model checkpoint. If int, will load the checkpoint of the</span>
<span class="sd">                specified epoch.</span>
<span class="sd">                (Default value = &#39;best&#39;)</span>
<span class="sd">            seed (int, optional): Seed used to make the sampling deterministic.</span>
<span class="sd">                (Default value = 42)</span>

<span class="sd">        If the Experiment has logging enabled (i.e. self.logging is True), one callback will be automatically</span>
<span class="sd">        included to saved the test metrics. Moreover, a :class:`~callbacks.AtomicCSVLogger` will save the test</span>
<span class="sd">        metrics in an output .tsv file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict sorting of all the test metrics values by their names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_seeds</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">callbacks</span>

        <span class="c1"># Copy callback list.</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="n">best_epoch_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">metrics_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate_generator</span><span class="p">(</span><span class="n">test_generator</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_metrics</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">test_metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">test_metrics</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate_generator</span><span class="p">(</span><span class="n">test_generator</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>
            <span class="n">test_metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="n">test_metrics_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_loss&#39;</span><span class="p">]</span> <span class="o">+</span> \
                             <span class="p">[</span><span class="s1">&#39;test_&#39;</span> <span class="o">+</span> <span class="n">metric_name</span> <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">metrics_names</span><span class="p">]</span>
        <span class="n">test_metrics_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">test_loss</span><span class="p">],</span> <span class="n">test_metrics</span><span class="p">))</span>

        <span class="n">test_metrics_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">test_metrics_names</span><span class="p">,</span> <span class="n">test_metrics_values</span><span class="p">))</span>
        <span class="n">test_metrics_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">test_metrics_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;On best model: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">test_metrics_str</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging</span><span class="p">:</span>
            <span class="n">test_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">test_metrics_values</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">test_metrics_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_epoch_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">best_epoch_stats</span> <span class="o">=</span> <span class="n">best_epoch_stats</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">test_stats</span> <span class="o">=</span> <span class="n">best_epoch_stats</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_stats</span><span class="p">)</span>
            <span class="n">test_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_log_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">test_metrics_dict</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018-2020, Frédérik Paradis

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>